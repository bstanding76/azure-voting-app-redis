# File: templates/cd-deploy.yaml

parameters:
  - name: environmentAKS
    type: string
    default: 'bstanding76azurevotingapp'


stages:
  - stage: DeployRedisAndApp
    displayName: Deploy stage Redis and App
    dependsOn: BuildRedis
    jobs:
    - job: FileVariable
      steps:
      - bash: |
          echo "##vso[task.setvariable variable=buildjob;]voteap_$(Build.BuildNumber)_$(Get-Date -Format yyyyMMddhhmmss).yaml"
          rename azure-vote-all-in-one-redis.yaml ${buildjob}
    - job: FileRename
      steps:
      - task: CopyFiles@2
        inputs:
          SourceFolder: './' # string. Source Folder.
          Contents: "voteap_$(Build.BuildNumber)_$(datetime).yaml" # string. Required. Contents. Default: **.
          TargetFolder: 'manifests/' # string. Required. Target Folder.
    - deployment: Deploy
      displayName: Deploy Job Redis
      environment: ${{ parameters.environmentAKS }}
      strategy:
        runOnce:
          deploy:
            steps:
            - task: KubernetesManifest@0
              displayName: Create imagePullSecret
              inputs:
                action: createSecret
                secretName: $(imagePullSecret)
                dockerRegistryEndpoint: ${{ variables.dockerRegistryServiceConnection }}

            - task: KubernetesManifest@0
              displayName: Deploy to Kubernetes cluster
              inputs:
                action: deploy
                manifests: |
                  $(Pipeline.Workspace)/manifests/voteap_$(Build.BuildNumber)_$(Get-Date -Format yyyyMMddhhmmss).yaml
#                  $(Pipeline.Workspace)/manifests/deployment-redis.yml
#                  $(Pipeline.Workspace)/manifests/service-redis.yml
                imagePullSecrets: |
                  ${{ variables.imagePullSecret }}
                containers: |
                  ${{ variables.dockerRegistryServiceConnection }}/${{ variables.imageRepositoryRedis }}:${{ variables.tag }}
    - job: PublishBuildArtif
      steps:
      - download: current
        artifact: democi
